 -- ==================================================
  -- SERVICE CATALOG DATABASE SCHEMA (NO TRIGGERS)
  -- ==================================================

  -- Drop tables in reverse dependency order
  DROP TABLE IF EXISTS t_catalog_service_resources CASCADE;
  DROP TABLE IF EXISTS t_catalog_resource_pricing CASCADE;
  DROP TABLE IF EXISTS t_catalog_resources CASCADE;
  DROP TABLE IF EXISTS t_catalog_items CASCADE;
  DROP TABLE IF EXISTS m_category_details CASCADE;
  DROP TABLE IF EXISTS m_category_master CASCADE;

  -- ==================================================
  -- 1. MASTER DATA TABLES (Product-Level)
  -- ==================================================

  -- Master categories for product-level LOVs
  CREATE TABLE m_category_master (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      category_name VARCHAR(100) NOT NULL UNIQUE,
      display_name VARCHAR(100) NOT NULL,
      is_active BOOLEAN DEFAULT true,
      description TEXT,
      icon_name VARCHAR(50),
      order_sequence INTEGER,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
  );

  -- Master category details for product-level LOVs
  CREATE TABLE m_category_details (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      sub_cat_name VARCHAR(100) NOT NULL,
      display_name VARCHAR(100) NOT NULL,
      category_id UUID NOT NULL REFERENCES m_category_master(id) ON DELETE CASCADE,
      hexcolor VARCHAR(10),
      icon_name VARCHAR(50),
      tags JSONB,
      tool_tip TEXT,
      is_active BOOLEAN DEFAULT true,
      sequence_no INTEGER DEFAULT 0,
      description TEXT,
      is_deletable BOOLEAN DEFAULT true,
      form_settings JSONB,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

      CONSTRAINT unique_subcat_per_category UNIQUE(sub_cat_name, category_id)
  );

  -- ==================================================
  -- 2. SERVICE CATALOG CORE TABLES
  -- ==================================================

  -- Enhanced service catalog items
  CREATE TABLE t_catalog_items (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      tenant_id UUID NOT NULL REFERENCES t_tenants(id) ON DELETE CASCADE,

      -- Basic Information
      name VARCHAR(255) NOT NULL,
      short_description TEXT,
      description_content TEXT,
      description_format VARCHAR(20) DEFAULT 'markdown',

      -- Classification
      type VARCHAR(50) DEFAULT 'service',
      industry_id VARCHAR(50) REFERENCES m_catalog_industries(id),
      category_id VARCHAR(50) REFERENCES m_catalog_categories(id),

      -- Status & Versioning
      status VARCHAR(20) DEFAULT 'draft',
      is_live BOOLEAN DEFAULT false,
      parent_id UUID REFERENCES t_catalog_items(id),
      is_variant BOOLEAN DEFAULT false,

      -- Pricing Configuration (JSONB)
      price_attributes JSONB DEFAULT '{}'::jsonb,

      -- Tax Configuration (JSONB)
      tax_config JSONB DEFAULT '{}'::jsonb,

      -- Service Attributes (JSONB)
      service_attributes JSONB DEFAULT '{}'::jsonb,

      -- Resource Requirements (JSONB)
      resource_requirements JSONB DEFAULT '{}'::jsonb,

      -- Technical Specifications (JSONB)
      specifications JSONB DEFAULT '{}'::jsonb,

      -- Terms & Conditions
      terms_content TEXT,
      terms_format VARCHAR(20) DEFAULT 'markdown',

      -- Variant Attributes
      variant_attributes JSONB DEFAULT '{}'::jsonb,

      -- Metadata & Search
      metadata JSONB DEFAULT '{}'::jsonb,
      search_vector tsvector,

      -- Audit Fields (Application manages these)
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      created_by UUID REFERENCES t_users(id),
      updated_by UUID REFERENCES t_users(id),

      -- Constraints
      CONSTRAINT valid_status CHECK (status IN ('draft', 'active', 'inactive', 'archived')),
      CONSTRAINT valid_type CHECK (type IN ('service', 'product', 'bundle')),
      CONSTRAINT unique_name_per_tenant UNIQUE(tenant_id, name, is_live)
  );

  -- ==================================================
  -- 3. RESOURCE TABLES (Enhanced)
  -- ==================================================

  -- Enhanced catalog resources
  CREATE TABLE t_catalog_resources (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      tenant_id UUID NOT NULL REFERENCES t_tenants(id) ON DELETE CASCADE,

      -- Basic Information
      name VARCHAR(255) NOT NULL,
      description TEXT,
      resource_type_id VARCHAR(50) NOT NULL REFERENCES m_catalog_resource_types(id),

      -- Availability & Capacity
      is_available BOOLEAN DEFAULT true,
      capacity_per_day INTEGER,
      capacity_per_hour INTEGER,
      working_hours JSONB DEFAULT '{}'::jsonb,

      -- Skills & Attributes
      skills JSONB DEFAULT '[]'::jsonb,
      attributes JSONB DEFAULT '{}'::jsonb,

      -- Location & Mobility
      location_id UUID,
      is_mobile BOOLEAN DEFAULT false,
      service_radius_km INTEGER,

      -- Cost & Pricing
      hourly_cost DECIMAL(15,4),
      daily_cost DECIMAL(15,4),
      currency_code VARCHAR(3) DEFAULT 'INR',

      -- Status
      status VARCHAR(20) DEFAULT 'active',
      is_live BOOLEAN DEFAULT true,

      -- Audit Fields (Application manages these)
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      created_by UUID REFERENCES t_users(id),
      updated_by UUID REFERENCES t_users(id),

      -- Constraints
      CONSTRAINT valid_resource_status CHECK (status IN ('active', 'inactive', 'maintenance', 'retired')),
      CONSTRAINT unique_resource_name_per_tenant UNIQUE(tenant_id, name)
  );

  -- ==================================================
  -- 4. JUNCTION TABLES
  -- ==================================================

  -- Service-Resource relationships
  CREATE TABLE t_catalog_service_resources (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      service_id UUID NOT NULL REFERENCES t_catalog_items(id) ON DELETE CASCADE,
      resource_type_id VARCHAR(50) NOT NULL REFERENCES m_catalog_resource_types(id),
      tenant_id UUID NOT NULL REFERENCES t_tenants(id) ON DELETE CASCADE,

      -- Allocation Configuration
      allocation_type_id UUID REFERENCES m_category_details(id),
      quantity_required INTEGER DEFAULT 1,
      duration_hours DECIMAL(5,2),

      -- Pricing
      unit_cost DECIMAL(15,4),
      currency_code VARCHAR(3) DEFAULT 'INR',
      is_billable BOOLEAN DEFAULT true,

      -- Constraints & Requirements
      required_skills JSONB DEFAULT '[]'::jsonb,
      required_attributes JSONB DEFAULT '{}'::jsonb,

      -- Sequence & Status
      sequence_order INTEGER DEFAULT 0,
      is_active BOOLEAN DEFAULT true,

      -- Audit Fields (Application manages these)
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

      CONSTRAINT unique_service_resource_type UNIQUE(service_id, resource_type_id, tenant_id)
  );

  -- Resource pricing configurations
  CREATE TABLE t_catalog_resource_pricing (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      resource_id UUID NOT NULL REFERENCES t_catalog_resources(id) ON DELETE CASCADE,
      tenant_id UUID NOT NULL REFERENCES t_tenants(id) ON DELETE CASCADE,

      -- Pricing Configuration
      pricing_type_id UUID REFERENCES m_category_details(id),
      base_rate DECIMAL(15,4) NOT NULL,
      currency_code VARCHAR(3) DEFAULT 'INR',

      -- Time-based Pricing
      peak_hour_multiplier DECIMAL(3,2) DEFAULT 1.0,
      weekend_multiplier DECIMAL(3,2) DEFAULT 1.0,
      holiday_multiplier DECIMAL(3,2) DEFAULT 1.0,

      -- Quantity-based Pricing
      min_quantity INTEGER DEFAULT 1,
      max_quantity INTEGER,

      -- Date Range
      effective_from DATE DEFAULT CURRENT_DATE,
      effective_to DATE,

      -- Status
      is_active BOOLEAN DEFAULT true,

      -- Audit Fields (Application manages these)
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

      CONSTRAINT valid_multipliers CHECK (
          peak_hour_multiplier >= 0 AND
          weekend_multiplier >= 0 AND
          holiday_multiplier >= 0
      ),
      CONSTRAINT valid_date_range CHECK (effective_to IS NULL OR effective_to >= effective_from),
      CONSTRAINT unique_resource_pricing_period UNIQUE(resource_id, pricing_type_id, effective_from)
  );

  -- ==================================================
  -- 5. INDEXES FOR PERFORMANCE
  -- ==================================================

  -- Service catalog indexes
  CREATE INDEX idx_catalog_items_tenant_status ON t_catalog_items(tenant_id, status, is_live);
  CREATE INDEX idx_catalog_items_industry_category ON t_catalog_items(industry_id, category_id) WHERE is_live = true;
  CREATE INDEX idx_catalog_items_search ON t_catalog_items USING GIN(search_vector);
  CREATE INDEX idx_catalog_items_parent ON t_catalog_items(parent_id) WHERE parent_id IS NOT NULL;

  -- Resource indexes
  CREATE INDEX idx_catalog_resources_tenant_type ON t_catalog_resources(tenant_id, resource_type_id, status);
  CREATE INDEX idx_catalog_resources_availability ON t_catalog_resources(is_available, status) WHERE is_live = true;
  CREATE INDEX idx_catalog_resources_skills ON t_catalog_resources USING GIN(skills);

  -- Junction table indexes
  CREATE INDEX idx_service_resources_service ON t_catalog_service_resources(service_id, is_active);
  CREATE INDEX idx_service_resources_resource_type ON t_catalog_service_resources(resource_type_id, tenant_id);

  -- Pricing indexes
  CREATE INDEX idx_resource_pricing_active ON t_catalog_resource_pricing(resource_id, is_active, effective_from, effective_to);

  -- Master data indexes
  CREATE INDEX idx_category_master_active ON m_category_master(category_name, is_active);
  CREATE INDEX idx_category_details_category ON m_category_details(category_id, is_active, sequence_no);

  -- ==================================================
  -- 6. ROW LEVEL SECURITY (RLS) POLICIES
  -- ==================================================

  -- Enable RLS on tenant-specific tables
  ALTER TABLE t_catalog_items ENABLE ROW LEVEL SECURITY;
  ALTER TABLE t_catalog_resources ENABLE ROW LEVEL SECURITY;
  ALTER TABLE t_catalog_service_resources ENABLE ROW LEVEL SECURITY;
  ALTER TABLE t_catalog_resource_pricing ENABLE ROW LEVEL SECURITY;

  -- Basic tenant isolation policies
  CREATE POLICY tenant_isolation_catalog_items ON t_catalog_items
      USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

  CREATE POLICY tenant_isolation_catalog_resources ON t_catalog_resources
      USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

  CREATE POLICY tenant_isolation_service_resources ON t_catalog_service_resources
      USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

  CREATE POLICY tenant_isolation_resource_pricing ON t_catalog_resource_pricing
      USING (tenant_id = current_setting('app.current_tenant_id')::uuid);